services:
  redis:
    image: redis:7-alpine

  discovery-server:
    build:
      context: ./Services/discovery-server
    ports:
      - "8761:8761"
    env_file:
      - ./env/common.env
      - ./env/eureka.env
    environment:
      LOGGING_FILE_NAME: /logs/discovery-server.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs

  customer-service:
    build:
      context: ./Services/customer-service
    depends_on:
      - discovery-server
      - redis
    env_file:
      - ./env/common.env
      - ./env/customer-service.env
    environment:
      LOGGING_FILE_NAME: /logs/customer-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs

  order-service:
    build:
      context: ./Services/order-service
    depends_on:
      - discovery-server
      - redis
    env_file:
      - ./env/common.env
      - ./env/order-service.env
    environment:
      LOGGING_FILE_NAME: /logs/order-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs

  cart-service:
    build:
      context: ./Services/cart-service
    depends_on:
      - discovery-server
      - redis
    env_file:
      - ./env/common.env
      - ./env/cart-service.env
    environment:
      LOGGING_FILE_NAME: /logs/cart-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs

  wishlist-service:
    build:
      context: ./Services/wishlist-service
    depends_on:
      - discovery-server
      - redis
    env_file:
      - ./env/common.env
      - ./env/wishlist-service.env
    environment:
      LOGGING_FILE_NAME: /logs/wishlist-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs

  product-service:
    build:
      context: ./Services/product-service
    depends_on:
      - discovery-server
      - redis
    env_file:
      - ./env/common.env
      - ./env/product-service.env
    environment:
      LOGGING_FILE_NAME: /logs/product-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs

  poster-service:
    build:
      context: ./Services/poster-service
    depends_on:
      - discovery-server
      - redis
    env_file:
      - ./env/common.env
      - ./env/poster-service.env
    environment:
      LOGGING_FILE_NAME: /logs/poster-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs

  admin-service:
    build:
      context: ./Services/admin-service
    depends_on:
      - discovery-server
    env_file:
      - ./env/common.env
    environment:
      LOGGING_FILE_NAME: /logs/admin-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs

  api-gateway:
    build:
      context: ./Services/api-gateway
    depends_on:
      - discovery-server
      - redis
    ports:
      - "8095:8080"
    env_file:
      - ./env/common.env
    environment:
      LOGGING_FILE_NAME: /logs/api-gateway.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs

  microservice-frontend:
    build:
      context: .
      dockerfile: microservce-frontend/Dockerfile
    depends_on:
      - api-gateway
    ports:
      - "8086:3000"
    env_file:
      - ./env/frontend.env
    command: /bin/sh -c "mkdir -p /logs && node server.js 2>&1 | tee -a /logs/microservice-frontend.log"
    volumes:
      - /home/ubuntu/microservice-logs:/logs
