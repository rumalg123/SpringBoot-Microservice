version: "3.9"

services:
  redis:
    image: redis:7-alpine
    environment:
      TZ: Asia/Colombo
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  discovery-server:
    build:
      context: ./Services/discovery-server
    ports:
      - "8761:8761"
    env_file:
      - ./env/common.env
      - ./env/eureka.env
    environment:
      TZ: Asia/Colombo
      LOGGING_FILE_NAME: /logs/discovery-server.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  customer-db:
    image: postgres:16-alpine
    environment:
      TZ: Asia/Colombo
      POSTGRES_DB: customer_db
      POSTGRES_USER: customer_user
      POSTGRES_PASSWORD: customer_pass
    ports:
      - "5433:5432"
    volumes:
      - customer-db-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  order-db:
    image: postgres:16-alpine
    environment:
      TZ: Asia/Colombo
      POSTGRES_DB: order_db
      POSTGRES_USER: order_user
      POSTGRES_PASSWORD: order_pass
    ports:
      - "5434:5432"
    volumes:
      - order-db-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  cart-db:
    image: postgres:16-alpine
    environment:
      TZ: Asia/Colombo
      POSTGRES_DB: cart_db
      POSTGRES_USER: cart_user
      POSTGRES_PASSWORD: cart_pass
    ports:
      - "5436:5432"
    volumes:
      - cart-db-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  wishlist-db:
    image: postgres:16-alpine
    environment:
      TZ: Asia/Colombo
      POSTGRES_DB: wishlist_db
      POSTGRES_USER: wishlist_user
      POSTGRES_PASSWORD: wishlist_pass
    ports:
      - "5437:5432"
    volumes:
      - wishlist-db-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  product-db:
    image: postgres:16-alpine
    environment:
      TZ: Asia/Colombo
      POSTGRES_DB: product_db
      POSTGRES_USER: product_user
      POSTGRES_PASSWORD: product_pass
    ports:
      - "5435:5432"
    volumes:
      - product-db-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  poster-db:
    image: postgres:16-alpine
    environment:
      TZ: Asia/Colombo
      POSTGRES_DB: poster_db
      POSTGRES_USER: poster_user
      POSTGRES_PASSWORD: poster_pass
    ports:
      - "5438:5432"
    volumes:
      - poster-db-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  vendor-db:
    image: postgres:16-alpine
    environment:
      TZ: Asia/Colombo
      POSTGRES_DB: vendor_db
      POSTGRES_USER: vendor_user
      POSTGRES_PASSWORD: vendor_pass
    ports:
      - "5439:5432"
    volumes:
      - vendor-db-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  access-db:
    image: postgres:16-alpine
    environment:
      TZ: Asia/Colombo
      POSTGRES_DB: access_db
      POSTGRES_USER: access_user
      POSTGRES_PASSWORD: access_pass
    ports:
      - "5440:5432"
    volumes:
      - access-db-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  promotion-db:
    image: postgres:16-alpine
    environment:
      TZ: Asia/Colombo
      POSTGRES_DB: promotion_db
      POSTGRES_USER: promotion_user
      POSTGRES_PASSWORD: promotion_pass
    ports:
      - "5441:5432"
    volumes:
      - promotion-db-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  admin-db:
    image: postgres:16-alpine
    environment:
      TZ: Asia/Colombo
      POSTGRES_DB: admin_db
      POSTGRES_USER: admin_user
      POSTGRES_PASSWORD: admin_pass
    ports:
      - "5442:5432"
    volumes:
      - admin-db-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  payment-db:
    image: postgres:16-alpine
    environment:
      TZ: Asia/Colombo
      POSTGRES_DB: payment_db
      POSTGRES_USER: payment_user
      POSTGRES_PASSWORD: payment_pass
    ports:
      - "5443:5432"
    volumes:
      - payment-db-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  inventory-db:
    image: postgres:16-alpine
    environment:
      TZ: Asia/Colombo
      POSTGRES_DB: inventory_db
      POSTGRES_USER: inventory_user
      POSTGRES_PASSWORD: inventory_pass
    ports:
      - "5444:5432"
    volumes:
      - inventory-db-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  review-db:
    image: postgres:16-alpine
    environment:
      TZ: Asia/Colombo
      POSTGRES_DB: review_db
      POSTGRES_USER: review_user
      POSTGRES_PASSWORD: review_pass
    ports:
      - "5445:5432"
    volumes:
      - review-db-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  personalization-db:
    image: postgres:16-alpine
    environment:
      TZ: Asia/Colombo
      POSTGRES_DB: personalization_db
      POSTGRES_USER: personalization_user
      POSTGRES_PASSWORD: personalization_pass
    ports:
      - "5446:5432"
    volumes:
      - personalization-db-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.17.0
    environment:
      TZ: Asia/Colombo
      discovery.type: single-node
      xpack.security.enabled: "false"
      ES_JAVA_OPTS: "-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 30s

  customer-service:
    build:
      context: ./Services/customer-service
    depends_on:
      - discovery-server
      - customer-db
      - redis
    env_file:
      - ./env/common.env
      - ./env/customer-service.env
    environment:
      TZ: Asia/Colombo
      LOGGING_FILE_NAME: /logs/customer-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  order-service:
    build:
      context: ./Services/order-service
    depends_on:
      - discovery-server
      - order-db
      - promotion-service
      - redis
    env_file:
      - ./env/common.env
      - ./env/order-service.env
    environment:
      TZ: Asia/Colombo
      LOGGING_FILE_NAME: /logs/order-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  cart-service:
    build:
      context: ./Services/cart-service
    depends_on:
      - discovery-server
      - cart-db
      - promotion-service
      - redis
    env_file:
      - ./env/common.env
      - ./env/cart-service.env
    environment:
      TZ: Asia/Colombo
      LOGGING_FILE_NAME: /logs/cart-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  wishlist-service:
    build:
      context: ./Services/wishlist-service
    depends_on:
      - discovery-server
      - wishlist-db
      - redis
    env_file:
      - ./env/common.env
      - ./env/wishlist-service.env
    environment:
      TZ: Asia/Colombo
      LOGGING_FILE_NAME: /logs/wishlist-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  product-service:
    build:
      context: ./Services/product-service
    depends_on:
      - discovery-server
      - product-db
      - redis
    env_file:
      - ./env/common.env
      - ./env/product-service.env
    environment:
      TZ: Asia/Colombo
      LOGGING_FILE_NAME: /logs/product-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  poster-service:
    build:
      context: ./Services/poster-service
    depends_on:
      - discovery-server
      - poster-db
      - redis
    env_file:
      - ./env/common.env
      - ./env/poster-service.env
    environment:
      TZ: Asia/Colombo
      LOGGING_FILE_NAME: /logs/poster-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  vendor-service:
    build:
      context: ./Services/vendor-service
    depends_on:
      - discovery-server
      - vendor-db
      - redis
    env_file:
      - ./env/common.env
      - ./env/vendor-service.env
    environment:
      TZ: Asia/Colombo
      LOGGING_FILE_NAME: /logs/vendor-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  access-service:
    build:
      context: ./Services/access-service
    depends_on:
      - discovery-server
      - access-db
      - redis
    env_file:
      - ./env/common.env
      - ./env/access-service.env
    environment:
      TZ: Asia/Colombo
      LOGGING_FILE_NAME: /logs/access-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  promotion-service:
    build:
      context: ./Services/promotion-service
    depends_on:
      - discovery-server
      - promotion-db
      - redis
      - access-service
      - vendor-service
    env_file:
      - ./env/common.env
      - ./env/promotion-service.env
    environment:
      TZ: Asia/Colombo
      LOGGING_FILE_NAME: /logs/promotion-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  payment-service:
    build:
      context: ./Services/payment-service
    depends_on:
      - discovery-server
      - payment-db
      - redis
    env_file:
      - ./env/common.env
      - ./env/payment-service.env
    environment:
      TZ: Asia/Colombo
      LOGGING_FILE_NAME: /logs/payment-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  inventory-service:
    build:
      context: ./Services/inventory-service
    depends_on:
      - discovery-server
      - inventory-db
      - redis
    env_file:
      - ./env/common.env
      - ./env/inventory-service.env
    environment:
      TZ: Asia/Colombo
      LOGGING_FILE_NAME: /logs/inventory-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  admin-service:
    build:
      context: ./Services/admin-service
    depends_on:
      - discovery-server
      - admin-db
      - access-service
    env_file:
      - ./env/common.env
      - ./env/admin-service.env
    environment:
      TZ: Asia/Colombo
      LOGGING_FILE_NAME: /logs/admin-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  review-service:
    build:
      context: ./Services/review-service
    depends_on:
      - discovery-server
      - review-db
      - redis
    env_file:
      - ./env/common.env
      - ./env/review-service.env
    environment:
      TZ: Asia/Colombo
      LOGGING_FILE_NAME: /logs/review-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  personalization-service:
    build:
      context: ./Services/personalization-service
    depends_on:
      - discovery-server
      - personalization-db
      - redis
    env_file:
      - ./env/common.env
      - ./env/personalization-service.env
    environment:
      TZ: Asia/Colombo
      LOGGING_FILE_NAME: /logs/personalization-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  analytics-service:
    build:
      context: ./Services/analytics-service
    depends_on:
      - discovery-server
      - redis
    env_file:
      - ./env/common.env
      - ./env/analytics-service.env
    environment:
      TZ: Asia/Colombo
      LOGGING_FILE_NAME: /logs/analytics-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  search-service:
    build:
      context: ./Services/search-service
    depends_on:
      discovery-server:
        condition: service_started
      redis:
        condition: service_started
      elasticsearch:
        condition: service_healthy
    env_file:
      - ./env/common.env
      - ./env/search-service.env
    environment:
      TZ: Asia/Colombo
      LOGGING_FILE_NAME: /logs/search-service.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  api-gateway:
    build:
      context: ./Services/api-gateway
    depends_on:
      - discovery-server
      - redis
      - access-service
    ports:
      - "8080:8080"
    env_file:
      - ./env/common.env
    environment:
      TZ: Asia/Colombo
      LOGGING_FILE_NAME: /logs/api-gateway.log
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  microservice-frontend:
    build:
      context: .
      dockerfile: microservce-frontend/Dockerfile
    depends_on:
      - api-gateway
    ports:
      - "8086:3000"
    env_file:
      - ./env/frontend.env
    command: /bin/sh -c "mkdir -p /logs && node server.js 2>&1 | tee -a /logs/microservice-frontend.log"
    environment:
      TZ: Asia/Colombo
    volumes:
      - /home/ubuntu/microservice-logs:/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

volumes:
  customer-db-data:
  order-db-data:
  cart-db-data:
  wishlist-db-data:
  product-db-data:
  poster-db-data:
  vendor-db-data:
  access-db-data:
  promotion-db-data:
  admin-db-data:
  payment-db-data:
  inventory-db-data:
  review-db-data:
  personalization-db-data:
  elasticsearch-data:
